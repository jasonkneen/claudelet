var ie=(i=>(i[i.Error=1]="Error",i[i.Warning=2]="Warning",i[i.Information=3]="Information",i[i.Hint=4]="Hint",i))(ie||{});import X from"path";var E={".ts":"typescript",".tsx":"typescriptreact",".js":"javascript",".jsx":"javascriptreact",".mjs":"javascript",".cjs":"javascript",".mts":"typescript",".cts":"typescript",".html":"html",".htm":"html",".css":"css",".scss":"scss",".sass":"sass",".less":"less",".vue":"vue",".svelte":"svelte",".astro":"astro",".json":"json",".jsonc":"jsonc",".yaml":"yaml",".yml":"yaml",".toml":"toml",".xml":"xml",".py":"python",".pyi":"python",".pyx":"python",".go":"go",".mod":"go.mod",".rs":"rust",".rb":"ruby",".erb":"erb",".rake":"ruby",".gemspec":"ruby",".php":"php",".java":"java",".kt":"kotlin",".kts":"kotlin",".c":"c",".h":"c",".cpp":"cpp",".cc":"cpp",".cxx":"cpp",".hpp":"cpp",".hxx":"hpp",".cs":"csharp",".swift":"swift",".sh":"shellscript",".bash":"shellscript",".zsh":"shellscript",".fish":"fish",".ex":"elixir",".exs":"elixir",".erl":"erlang",".lua":"lua",".zig":"zig",".dart":"dart",".scala":"scala",".sc":"scala",".hs":"haskell",".ml":"ocaml",".mli":"ocaml",".sql":"sql",".md":"markdown",".mdx":"mdx",Dockerfile:"dockerfile",".dockerfile":"dockerfile",".graphql":"graphql",".gql":"graphql",".prisma":"prisma",".tf":"terraform",".tfvars":"terraform"};function B(s){let e=X.extname(s).toLowerCase(),t=X.basename(s);return E[t]?E[t]:E[e]||"plaintext"}function re(s){for(let[e,t]of Object.entries(E))if(t===s)return e;return null}import d from"path";import l from"fs/promises";import Y from"fs";import T from"os";import{spawn as O,execFileSync as F}from"child_process";import ae from"zlib";var R="1",k="lsp-client",q=null,_=null;function H(s){s.appName&&(k=s.appName),s.cacheDir&&(q=s.cacheDir),s.bunPath&&(_=s.bunPath)}function x(){if(q)return q;if(process.platform==="darwin")return d.join(T.homedir(),"Library","Application Support",k,"lsp");if(process.platform==="win32")return d.join(process.env.APPDATA||d.join(T.homedir(),"AppData","Roaming"),k,"lsp");{let s=process.env.XDG_DATA_HOME||d.join(T.homedir(),".local","share");return d.join(s,k,"lsp")}}function P(){return d.join(x(),"bin")}function z(){return d.join(x(),"node_modules")}async function M(){let s=x(),e=d.join(s,".cache-version");try{await l.mkdir(s,{recursive:!0}),await l.mkdir(P(),{recursive:!0});try{(await l.readFile(e,"utf-8")).trim()!==R&&(console.log("[LSP Installer] Cache version mismatch, clearing cache"),await Z())}catch{await l.writeFile(e,R)}}catch(t){throw console.error("[LSP Installer] Failed to create cache directory:",t),t}}async function Z(){let s=x();try{let e=await l.readdir(s);for(let t of e)t!==".cache-version"&&await l.rm(d.join(s,t),{recursive:!0,force:!0});await l.mkdir(P(),{recursive:!0}),await l.writeFile(d.join(s,".cache-version"),R),console.log("[LSP Installer] Cache cleared")}catch(e){console.error("[LSP Installer] Failed to clear cache:",e)}}async function oe(){let s=x(),e=0,t=[];async function n(i){let r=0;try{let a=await l.readdir(i,{withFileTypes:!0});for(let o of a){let c=d.join(i,o.name);if(o.isDirectory())r+=await n(c);else{let u=await l.stat(c);r+=u.size}}}catch{}return r}try{e=await n(s);let i=P();try{let a=await l.readdir(i);t.push(...a.filter(o=>!o.startsWith(".")))}catch{}let r=z();try{let a=d.join(r,".bin"),o=await l.readdir(a);t.push(...o.filter(c=>!c.startsWith(".")))}catch{}}catch{}return{path:s,size:e,version:R,packages:[...new Set(t)]}}function g(s){try{let e=process.platform==="win32"?"where":"which";return F(e,[s],{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim().split(`
`)[0].trim()||null}catch{return null}}function Q(){if(_&&Y.existsSync(_))return _;if(process.env.NODE_ENV==="development")return g("bun");let s=process.resourcesPath||d.join(__dirname,"..","..","resources"),e=process.platform==="win32"?"bun.exe":"bun",t=d.join(s,"bin",e);return Y.existsSync(t)?t:g("bun")}function ee(){return g("npm")}async function b(s,e){let{packageName:t,entryPoint:n}=s;await M();let i=z(),r=d.join(i,n);try{return await l.access(r),console.log(`[LSP Installer] ${t} already installed at ${r}`),r}catch{}e&&e({stage:"installing",package:t}),console.log(`[LSP Installer] Installing npm package: ${t}`);let a=Q(),o=ee();if(!a&&!o)throw new Error("Neither bun nor npm found. Cannot install LSP server.");await l.mkdir(i,{recursive:!0});let c=d.join(x(),"package.json");try{await l.access(c)}catch{await l.writeFile(c,JSON.stringify({name:`${k}-lsp`,private:!0},null,2))}return new Promise((u,w)=>{let v=x(),h,S=t.split(/\s+/).filter(Boolean);a?(console.log(`[LSP Installer] Using bun: ${a}`),console.log("[LSP Installer] Installing packages:",S),h=O(a,["add",...S],{cwd:v,env:{...process.env,BUN_INSTALL_CACHE_DIR:d.join(v,".bun-cache")},stdio:["pipe","pipe","pipe"]})):(console.log(`[LSP Installer] Using npm: ${o}`),console.log("[LSP Installer] Installing packages:",S),h=O(o,["install",...S,"--save"],{cwd:v,stdio:["pipe","pipe","pipe"]}));let I="",D=!1;h.stderr?.on("data",y=>{I+=y.toString(),!D&&e&&(e({stage:"downloading",package:t}),D=!0)}),h.stdout?.on("data",()=>{!D&&e&&(e({stage:"downloading",package:t}),D=!0)}),h.on("close",async y=>{if(y!==0){console.error("[LSP Installer] Install failed:",I),w(new Error(`Failed to install ${t}: ${I}`));return}e&&e({stage:"extracting",package:t});try{await l.access(r),console.log(`[LSP Installer] Successfully installed ${t}`),e&&e({stage:"complete",package:t}),u(r)}catch{w(new Error(`Installed ${t} but binary not found at ${n}`))}}),h.on("error",y=>{w(new Error(`Failed to spawn package manager: ${y.message}`))})})}async function U(s,e){let{packagePath:t,binaryName:n}=s;await M();let i=process.platform==="win32"?".exe":"",r=d.join(P(),n+i);try{return await l.access(r),console.log(`[LSP Installer] ${n} already installed at ${r}`),r}catch{}let a=g("go");if(!a)throw new Error("Go is required to install "+n);return e&&e({stage:"installing",package:n}),console.log(`[LSP Installer] Installing Go package: ${t}`),new Promise((o,c)=>{let u=O(a,["install",t],{env:{...process.env,GOBIN:P()},stdio:["pipe","pipe","pipe"]}),w="",v=!1;u.stderr?.on("data",h=>{w+=h.toString(),!v&&e&&(e({stage:"downloading",package:n}),v=!0)}),u.stdout?.on("data",()=>{!v&&e&&(e({stage:"downloading",package:n}),v=!0)}),u.on("close",async h=>{if(h!==0){console.error("[LSP Installer] Go install failed:",w),c(new Error(`Failed to install ${n}: ${w}`));return}e&&e({stage:"extracting",package:n});try{await l.access(r),console.log(`[LSP Installer] Successfully installed ${n}`),e&&e({stage:"complete",package:n}),o(r)}catch{c(new Error(`Installed ${n} but binary not found`))}}),u.on("error",h=>{c(new Error(`Failed to run go install: ${h.message}`))})})}async function G(s,e){let{repo:t,binaryName:n,getAssetName:i}=s;await M();let r=process.platform==="win32"?".exe":"",a=d.join(P(),n+r);try{return await l.access(a),console.log(`[LSP Installer] ${n} already installed at ${a}`),a}catch{}e&&e({stage:"fetching",package:n}),console.log(`[LSP Installer] Fetching latest release from ${t}`);let o=`https://api.github.com/repos/${t}/releases/latest`,c=await fetch(o,{headers:{"User-Agent":`${k}-LSP-Installer`}});if(!c.ok)throw new Error(`Failed to fetch release info: ${c.status}`);let u=await c.json(),w=process.platform,v=process.arch,h=i(u,w,v);if(!h)throw new Error(`No compatible release found for ${w}-${v}`);let S=u.assets.find(se=>se.name===h);if(!S)throw new Error(`Asset ${h} not found in release`);e&&e({stage:"downloading",package:n,size:S.size}),console.log(`[LSP Installer] Downloading ${h} (${(S.size/1024/1024).toFixed(2)} MB)`);let I=await fetch(S.browser_download_url,{headers:{"User-Agent":`${k}-LSP-Installer`}});if(!I.ok)throw new Error(`Failed to download: ${I.status}`);let D=Buffer.from(await I.arrayBuffer()),y=d.join(P(),h);await l.writeFile(y,D),e&&e({stage:"extracting",package:n}),console.log(`[LSP Installer] Extracting ${h}`);try{h.endsWith(".zip")?await ce(y,P(),n):h.endsWith(".tar.gz")||h.endsWith(".tar.xz")?await le(y,P(),n):h.endsWith(".gz")&&!h.endsWith(".tar.gz")?await pe(y,a):await l.rename(y,a)}finally{try{await l.unlink(y)}catch{}}process.platform!=="win32"&&await l.chmod(a,493);try{return await l.access(a),console.log(`[LSP Installer] Successfully installed ${n}`),e&&e({stage:"complete",package:n}),a}catch{throw new Error(`Extracted ${n} but binary not found`)}}async function ce(s,e,t){let n=process.platform==="win32"?".exe":"",i=t+n;process.platform==="win32"?F("powershell",["-Command",`Expand-Archive -Path "${s}" -DestinationPath "${e}" -Force`]):F("unzip",["-o","-q",s,"-d",e]),await te(e,i)}async function le(s,e,t){let n=process.platform==="win32"?".exe":"",i=t+n;F("tar",["-xf",s,"-C",e]),await te(e,i)}async function pe(s,e){let t=await l.readFile(s),n=ae.gunzipSync(t);await l.writeFile(e,n)}async function te(s,e){let t=d.join(s,e);try{await l.access(t);return}catch{}async function n(r,a=0){if(a>3)return null;let o=await l.readdir(r,{withFileTypes:!0});for(let c of o){let u=d.join(r,c.name);if(c.isFile()&&c.name===e)return u;if(c.isDirectory()){let w=await n(u,a+1);if(w)return w}}return null}let i=await n(s);i&&i!==t&&await l.rename(i,t)}async function C(s){let e=process.platform==="win32"?".exe":"",t=d.join(P(),s+e);try{return await l.access(t),!0}catch{return!1}}function A(s){let e=process.platform==="win32"?".exe":"";return d.join(P(),s+e)}function m(s){return d.join(z(),s)}import j from"path";import{spawn as p}from"child_process";import f from"fs/promises";import ue from"os";async function W(s,e,t=[]){let n=j.dirname(s),i=ue.homedir();for(;n!==i&&n!=="/"&&n!==j.parse(n).root;){for(let r of t)try{return await f.access(j.join(n,r)),null}catch{}for(let r of e)try{return await f.access(j.join(n,r)),n}catch{}n=j.dirname(n)}return null}var L={typescript:{id:"typescript",name:"TypeScript",extensions:[".ts",".tsx",".js",".jsx",".mjs",".cjs"],rootPatterns:["package.json","tsconfig.json","jsconfig.json"],excludePatterns:["deno.json","deno.jsonc"],installable:!0,async checkInstalled(){let s=m(".bin/typescript-language-server");try{return await f.access(s),!0}catch{}return!!g("typescript-language-server")},async install(s){return b({packageName:"typescript-language-server typescript",entryPoint:".bin/typescript-language-server"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/typescript-language-server");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("typescript-language-server");if(r)return p(r,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing typescript-language-server...");let a=await this.install(e.onProgress);return p(a,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})},initialization:{preferences:{includeCompletionsForModuleExports:!0,includeCompletionsWithInsertText:!0}}},eslint:{id:"eslint",name:"ESLint",extensions:[".ts",".tsx",".js",".jsx",".mjs",".cjs",".vue",".svelte"],rootPatterns:[".eslintrc",".eslintrc.js",".eslintrc.json",".eslintrc.yaml","eslint.config.js","eslint.config.mjs"],installable:!0,async checkInstalled(){let s=m(".bin/vscode-eslint-language-server");try{return await f.access(s),!0}catch{}return!!g("vscode-eslint-language-server")},async install(s){return b({packageName:"vscode-langservers-extracted",entryPoint:".bin/vscode-eslint-language-server"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/vscode-eslint-language-server");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("vscode-eslint-language-server");if(r)return p(r,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing vscode-eslint-language-server...");let a=await this.install(e.onProgress);return p(a,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})},initialization:{settings:{validate:"on",run:"onType"}}},json:{id:"json",name:"JSON",extensions:[".json",".jsonc"],rootPatterns:["package.json"],installable:!0,async checkInstalled(){let s=m(".bin/vscode-json-language-server");try{return await f.access(s),!0}catch{}return!!g("vscode-json-language-server")},async install(s){return b({packageName:"vscode-langservers-extracted",entryPoint:".bin/vscode-json-language-server"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/vscode-json-language-server");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("vscode-json-language-server");if(r)return p(r,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing vscode-json-language-server...");let a=await this.install();return p(a,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}},css:{id:"css",name:"CSS/SCSS/Less",extensions:[".css",".scss",".sass",".less"],rootPatterns:["package.json"],installable:!0,async checkInstalled(){let s=m(".bin/vscode-css-language-server");try{return await f.access(s),!0}catch{}return!!g("vscode-css-language-server")},async install(s){return b({packageName:"vscode-langservers-extracted",entryPoint:".bin/vscode-css-language-server"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/vscode-css-language-server");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("vscode-css-language-server");if(r)return p(r,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing vscode-css-language-server...");let a=await this.install();return p(a,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}},html:{id:"html",name:"HTML",extensions:[".html",".htm"],rootPatterns:["package.json","index.html"],installable:!0,async checkInstalled(){let s=m(".bin/vscode-html-language-server");try{return await f.access(s),!0}catch{}return!!g("vscode-html-language-server")},async install(s){return b({packageName:"vscode-langservers-extracted",entryPoint:".bin/vscode-html-language-server"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/vscode-html-language-server");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("vscode-html-language-server");if(r)return p(r,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing vscode-html-language-server...");let a=await this.install();return p(a,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}},python:{id:"python",name:"Python (Pyright)",extensions:[".py",".pyi"],rootPatterns:["pyproject.toml","setup.py","requirements.txt","Pipfile"],installable:!0,async checkInstalled(){let s=m(".bin/pyright-langserver");try{return await f.access(s),!0}catch{}return!!g("pyright-langserver")||!!g("pyright")},async install(s){return b({packageName:"pyright",entryPoint:".bin/pyright-langserver"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/pyright-langserver");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("pyright-langserver");if(r)return p(r,["--stdio"],{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});let a=g("pyright");if(a)return p(a,["--langserver","--stdio"],{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing pyright...");let o=await this.install();return p(o,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}},go:{id:"go",name:"Go (gopls)",extensions:[".go"],rootPatterns:["go.mod","go.sum"],installable:!0,async checkInstalled(){return await C("gopls")?!0:!!g("gopls")},async install(s){return U({packagePath:"golang.org/x/tools/gopls@latest",binaryName:"gopls"},s)},async spawn(s,e={}){let t={...process.env,...e.env};if(await C("gopls")){let i=A("gopls");return p(i,[],{cwd:s,env:t,stdio:["pipe","pipe","pipe"]})}let n=g("gopls");if(n)return p(n,[],{cwd:s,env:t,stdio:["pipe","pipe","pipe"]});if(g("go")){console.log("[LSP] Auto-installing gopls...");let i=await this.install();return p(i,[],{cwd:s,env:t,stdio:["pipe","pipe","pipe"]})}return null}},rust:{id:"rust",name:"Rust (rust-analyzer)",extensions:[".rs"],rootPatterns:["Cargo.toml"],installable:!0,async checkInstalled(){return await C("rust-analyzer")?!0:!!g("rust-analyzer")},async install(s){return G({repo:"rust-lang/rust-analyzer",binaryName:"rust-analyzer",getAssetName:(e,t,n)=>{let i={darwin:"apple-darwin",linux:"unknown-linux-gnu",win32:"pc-windows-msvc"},r={x64:"x86_64",arm64:"aarch64"},a=i[t],o=r[n];return!a||!o?null:`rust-analyzer-${o}-${a}${t==="win32"?".zip":".gz"}`}},s)},async spawn(s,e={}){let t={...process.env,...e.env};if(await C("rust-analyzer")){let r=A("rust-analyzer");return p(r,[],{cwd:s,env:t,stdio:["pipe","pipe","pipe"]})}let n=g("rust-analyzer");if(n)return p(n,[],{cwd:s,env:t,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing rust-analyzer...");let i=await this.install();return p(i,[],{cwd:s,env:t,stdio:["pipe","pipe","pipe"]})}},yaml:{id:"yaml",name:"YAML",extensions:[".yaml",".yml"],rootPatterns:["package.json"],installable:!0,async checkInstalled(){let s=m(".bin/yaml-language-server");try{return await f.access(s),!0}catch{}return!!g("yaml-language-server")},async install(s){return b({packageName:"yaml-language-server",entryPoint:".bin/yaml-language-server"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/yaml-language-server");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("yaml-language-server");if(r)return p(r,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing yaml-language-server...");let a=await this.install();return p(a,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}},tailwindcss:{id:"tailwindcss",name:"Tailwind CSS",extensions:[".css",".html",".jsx",".tsx",".vue",".svelte"],rootPatterns:["tailwind.config.js","tailwind.config.ts","tailwind.config.cjs","tailwind.config.mjs"],installable:!0,async checkInstalled(){let s=m(".bin/tailwindcss-language-server");try{return await f.access(s),!0}catch{}return!!g("tailwindcss-language-server")},async install(s){return b({packageName:"@tailwindcss/language-server",entryPoint:".bin/tailwindcss-language-server"},s)},async spawn(s,e={}){let t=["--stdio"],n={...process.env,...e.env},i=m(".bin/tailwindcss-language-server");try{return await f.access(i),p(i,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}catch{}let r=g("tailwindcss-language-server");if(r)return p(r,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]});console.log("[LSP] Auto-installing tailwindcss-language-server...");let a=await this.install();return p(a,t,{cwd:s,env:n,stdio:["pipe","pipe","pipe"]})}}};function V(s){return Object.values(L).filter(e=>e.extensions.includes(s.toLowerCase()))}function de(s){return L[s]||null}function J(){return{...L}}import{EventEmitter as he}from"events";import ne from"fs/promises";function me(s){let e=s.indexOf(`\r
\r
`);if(e===-1)return null;let t=s.subarray(0,e).toString("utf-8"),n={};for(let c of t.split(`\r
`)){let u=c.indexOf(": ");if(u!==-1){let w=c.substring(0,u),v=c.substring(u+2);n[w.toLowerCase()]=v}}let i=parseInt(n["content-length"],10);if(isNaN(i))return null;let r=e+4,a=r+i;if(s.length<a)return null;let o=s.subarray(r,a).toString("utf-8");return{headers:n,body:o,consumed:a}}var N=class extends he{serverID;root;process;initialization;requestId=0;pendingRequests=new Map;_diagnostics=new Map;_openDocuments=new Set;documentVersions=new Map;buffer=Buffer.alloc(0);initialized=!1;capabilities=null;constructor(e){super(),this.serverID=e.serverID,this.root=e.root,this.process=e.process,this.initialization=e.initialization||{},this._setupProcessHandlers()}get diagnostics(){return this._diagnostics}get openDocuments(){return this._openDocuments}_setupProcessHandlers(){this.process.stdout?.on("data",e=>{this.buffer=Buffer.concat([this.buffer,e]),this._processBuffer()}),this.process.stderr?.on("data",e=>{console.log(`[LSP:${this.serverID}] stderr:`,e.toString())}),this.process.on("close",e=>{console.log(`[LSP:${this.serverID}] Process exited with code ${e}`),this.emit("close",e)}),this.process.on("error",e=>{console.error(`[LSP:${this.serverID}] Process error:`,e),this.emit("error",e)})}_processBuffer(){for(;;){let e=me(this.buffer);if(!e)break;this.buffer=this.buffer.subarray(e.consumed);try{let t=JSON.parse(e.body);this._handleMessage(t)}catch(t){console.error(`[LSP:${this.serverID}] Failed to parse message:`,t)}}}_handleMessage(e){if(e.id!==void 0&&(e.result!==void 0||e.error!==void 0)){let t=this.pendingRequests.get(e.id);t&&(this.pendingRequests.delete(e.id),t.timeout&&clearTimeout(t.timeout),e.error?t.reject(new Error(e.error.message||"LSP error")):t.resolve(e.result));return}e.method&&(this._handleNotification(e.method,e.params),e.id!==void 0&&this._handleRequest(e.id,e.method,e.params))}_handleNotification(e,t){switch(e){case"textDocument/publishDiagnostics":this._handleDiagnostics(t);break;case"window/logMessage":console.log(`[LSP:${this.serverID}] ${t.message}`);break;case"window/showMessage":console.log(`[LSP:${this.serverID}] [${t.type}] ${t.message}`);break;default:break}}_handleRequest(e,t,n){let i=null;switch(t){case"workspace/workspaceFolders":i=[{name:"workspace",uri:`file://${this.root}`}];break;case"workspace/configuration":i=[this.initialization];break;case"client/registerCapability":i=null;break;default:console.log(`[LSP:${this.serverID}] Unhandled request: ${t}`)}this._sendMessage({jsonrpc:"2.0",id:e,result:i})}_handleDiagnostics(e){let t=e.uri,n=t.startsWith("file://")?decodeURIComponent(t.slice(7)):t;this._diagnostics.set(n,e.diagnostics||[]),this.emit("diagnostics",{path:n,diagnostics:e.diagnostics||[]})}_sendMessage(e){let t=JSON.stringify(e),n=`Content-Length: ${Buffer.byteLength(t)}\r
\r
`;this.process.stdin?.write(n+t)}_sendRequest(e,t,n=1e4){return new Promise((i,r)=>{let a=++this.requestId,o=setTimeout(()=>{this.pendingRequests.has(a)&&(this.pendingRequests.delete(a),r(new Error(`LSP request timeout: ${e}`)))},n);this.pendingRequests.set(a,{resolve:i,reject:r,timeout:o}),this._sendMessage({jsonrpc:"2.0",id:a,method:e,params:t})})}_sendNotification(e,t){this._sendMessage({jsonrpc:"2.0",method:e,params:t})}async initialize(){if(this.initialized)return this.capabilities;let e=await this._sendRequest("initialize",{processId:process.pid,rootUri:`file://${this.root}`,rootPath:this.root,workspaceFolders:[{name:"workspace",uri:`file://${this.root}`}],capabilities:{workspace:{workspaceFolders:!0,configuration:!0,didChangeConfiguration:{dynamicRegistration:!0}},textDocument:{synchronization:{dynamicRegistration:!0,willSave:!1,willSaveWaitUntil:!1,didSave:!0},completion:{dynamicRegistration:!0,completionItem:{snippetSupport:!0,commitCharactersSupport:!0,documentationFormat:["markdown","plaintext"]}},hover:{dynamicRegistration:!0,contentFormat:["markdown","plaintext"]},signatureHelp:{dynamicRegistration:!0,signatureInformation:{documentationFormat:["markdown","plaintext"]}},definition:{dynamicRegistration:!0},references:{dynamicRegistration:!0},documentHighlight:{dynamicRegistration:!0},documentSymbol:{dynamicRegistration:!0},codeAction:{dynamicRegistration:!0},codeLens:{dynamicRegistration:!0},formatting:{dynamicRegistration:!0},rangeFormatting:{dynamicRegistration:!0},rename:{dynamicRegistration:!0},publishDiagnostics:{relatedInformation:!0,tagSupport:{valueSet:[1,2]}}}},initializationOptions:this.initialization});return this.capabilities=e.capabilities,this._sendNotification("initialized",{}),this.initialized=!0,console.log(`[LSP:${this.serverID}] Initialized for ${this.root}`),this.capabilities}async openDocument(e){if(!this._openDocuments.has(e))try{let t=await ne.readFile(e,"utf-8"),n=B(e),i=1;this.documentVersions.set(e,i),this._openDocuments.add(e),this._sendNotification("textDocument/didOpen",{textDocument:{uri:`file://${e}`,languageId:n,version:i,text:t}})}catch(t){console.error(`[LSP:${this.serverID}] Failed to open document:`,t)}}async changeDocument(e,t){if(!this._openDocuments.has(e)){await this.openDocument(e);return}let n=(this.documentVersions.get(e)||0)+1;this.documentVersions.set(e,n),this._sendNotification("textDocument/didChange",{textDocument:{uri:`file://${e}`,version:n},contentChanges:[{text:t}]})}async saveDocument(e){if(this._openDocuments.has(e))try{let t=await ne.readFile(e,"utf-8");this._sendNotification("textDocument/didSave",{textDocument:{uri:`file://${e}`},text:t})}catch(t){console.error(`[LSP:${this.serverID}] Failed to save notification:`,t)}}closeDocument(e){this._openDocuments.has(e)&&(this._openDocuments.delete(e),this.documentVersions.delete(e),this._diagnostics.delete(e),this._sendNotification("textDocument/didClose",{textDocument:{uri:`file://${e}`}}))}async hover(e,t,n){return this._openDocuments.has(e)||await this.openDocument(e),this._sendRequest("textDocument/hover",{textDocument:{uri:`file://${e}`},position:{line:t,character:n}})}async completion(e,t,n){return this._openDocuments.has(e)||await this.openDocument(e),this._sendRequest("textDocument/completion",{textDocument:{uri:`file://${e}`},position:{line:t,character:n}})}async definition(e,t,n){return this._openDocuments.has(e)||await this.openDocument(e),this._sendRequest("textDocument/definition",{textDocument:{uri:`file://${e}`},position:{line:t,character:n}})}async references(e,t,n){return this._openDocuments.has(e)||await this.openDocument(e),await this._sendRequest("textDocument/references",{textDocument:{uri:`file://${e}`},position:{line:t,character:n},context:{includeDeclaration:!0}})||[]}getDiagnostics(){let e={};for(let[t,n]of this._diagnostics)e[t]=n;return e}waitForDiagnostics(e,t=3e3){return new Promise(n=>{if(this._diagnostics.has(e)){n(this._diagnostics.get(e));return}let i=setTimeout(()=>{this.off("diagnostics",r),n([])},t),r=a=>{a.path===e&&(clearTimeout(i),this.off("diagnostics",r),n(a.diagnostics))};this.on("diagnostics",r)})}async shutdown(){if(this.process.killed||this.process.exitCode!==null){try{this.process.stdin?.end(),this.process.stdout?.destroy(),this.process.stderr?.destroy()}catch{}return}try{await this._sendRequest("shutdown",null,100)}catch{}try{this._sendNotification("exit",null)}catch{}await Promise.race([new Promise(t=>{if(this.process.killed||this.process.exitCode!==null){t();return}let n=()=>{t()};this.process.once("exit",n),this.process.once("close",n),setTimeout(()=>{this.process.off("exit",n),this.process.off("close",n)},4e3)}),new Promise(t=>setTimeout(t,4e3))]),this.process&&this.process.exitCode===null&&!this.process.killed&&(console.log(`[LSP:${this.serverID}] Force killing unresponsive server`),this.process.kill("SIGKILL"));try{this.process.stdin?.end(),this.process.stdout?.destroy(),this.process.stderr?.destroy()}catch{}}getInfo(){return{serverID:this.serverID,root:this.root,initialized:this.initialized,openDocuments:Array.from(this._openDocuments),diagnosticCount:Array.from(this._diagnostics.values()).reduce((e,t)=>e+t.length,0)}}};import fe from"path";import{EventEmitter as we}from"events";var K=class{retries=new Map;timers=new Map;MAX_RETRIES=5;RETRY_DELAYS=[1e3,2e3,4e3,8e3,16e3];scheduleRetry(e,t){let n=this.retries.get(e)||0;if(n>=this.MAX_RETRIES){console.log(`[LSP] Max retries reached for ${e}`);return}let i=this.RETRY_DELAYS[n];console.log(`[LSP] Scheduling retry ${n+1}/${this.MAX_RETRIES} for ${e} in ${i}ms`);let r=this.timers.get(e);r&&clearTimeout(r);let a=setTimeout(async()=>{this.timers.delete(e);try{await t()}catch(o){console.error(`[LSP] Retry failed for ${e}:`,o)}},i);this.timers.set(e,a),this.retries.set(e,n+1)}clearRetries(e){let t=this.timers.get(e);t&&(clearTimeout(t),this.timers.delete(e)),this.retries.delete(e)}cancelAll(){for(let e of this.timers.values())clearTimeout(e);this.timers.clear(),this.retries.clear()}getRetryCount(e){return this.retries.get(e)||0}},$=class extends we{clients=new Map;spawning=new Map;broken=new Set;projectPath;enabled=new Set;disabled=new Set;lazyMode=!0;retryStrategy=new K;installerOptions;installerInitialized=!1;instanceId;constructor(e={}){super(),this.projectPath=e.projectPath||process.cwd(),this.instanceId=this._hashPath(this.projectPath).substring(0,8),this.installerOptions={appName:e.appName,cacheDir:e.cacheDir,bunPath:e.bunPath};for(let t of Object.keys(L))this.enabled.add(t);console.log(`[LSP:${this.instanceId}] Created manager for project: ${this.projectPath}`)}_hashPath(e){let t=0;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t}return Math.abs(t).toString(16).padStart(8,"0")}ensureInstallerInitialized(){this.installerInitialized||(H(this.installerOptions),this.installerInitialized=!0)}getProjectPath(){return this.projectPath}getInstanceId(){return this.instanceId}setProjectPath(e){this.clients.size>0&&console.warn(`[LSP:${this.instanceId}] Warning: setProjectPath called after servers already started. This may cause unexpected behavior. Consider creating a new LSPManager instance instead.`),this.projectPath=e,console.log(`[LSP:${this.instanceId}] Project path changed to: ${e}`)}setServerEnabled(e,t){t?(this.disabled.delete(e),this.enabled.add(e)):(this.enabled.delete(e),this.disabled.add(e),this._shutdownServer(e)),this.emit("server-status-changed",{serverId:e,enabled:t})}isServerEnabled(e){return this.enabled.has(e)&&!this.disabled.has(e)}async _shutdownServer(e){let t=[];for(let[n,i]of this.clients)i.serverID===e&&(t.push(n),await i.shutdown());for(let n of t)this.clients.delete(n)}async getClientsForFile(e){let t=fe.extname(e).toLowerCase(),n=V(t),i=[];for(let r of n){if(!this.isServerEnabled(r.id))continue;let a=await W(e,r.rootPatterns,r.excludePatterns);if(!a)continue;let o=`${r.id}:${a}`;if(this.broken.has(o))continue;if(this.clients.has(o)){i.push(this.clients.get(o));continue}if(this.spawning.has(o)){try{let u=await this.spawning.get(o);u&&i.push(u)}catch{}continue}let c=this._spawnClient(r,a,o);this.spawning.set(o,c);try{let u=await c;u?i.push(u):this.retryStrategy.scheduleRetry(o,async()=>{this.emit("server-retrying",{serverId:r.id,root:a,attempt:this.retryStrategy.getRetryCount(o)}),await this._retrySpawn(r,a,o)})}catch(u){console.error(`[LSP] Failed to spawn ${r.id}:`,u),this.broken.add(o),this.retryStrategy.scheduleRetry(o,async()=>{this.emit("server-retrying",{serverId:r.id,root:a,attempt:this.retryStrategy.getRetryCount(o)}),await this._retrySpawn(r,a,o)})}finally{this.spawning.delete(o)}}return i}async _spawnClient(e,t,n){this.ensureInstallerInitialized(),console.log(`[LSP] Spawning ${e.id} for ${t}`);let i=o=>{this.emit("server-installing",{serverId:e.id,progress:{stage:o.stage,package:o.package}})},r=await e.spawn(t,{onProgress:i});if(!r)return console.log(`[LSP] ${e.id} not available (binary not found)`),null;let a=new N({serverID:e.id,root:t,process:r,initialization:e.initialization});a.on("diagnostics",o=>{this.emit("diagnostics",o)}),a.on("close",()=>{console.log(`[LSP] ${e.id} closed for ${t}`),this.clients.delete(n),this.emit("server-closed",{serverId:e.id,root:t})}),a.on("error",()=>{this.broken.add(n)});try{return await a.initialize(),this.clients.set(n,a),this.retryStrategy.clearRetries(n),this.broken.delete(n),this.emit("server-started",{serverId:e.id,root:t}),a}catch(o){return console.error(`[LSP] ${e.id} initialization failed:`,o),this.broken.add(n),await a.shutdown(),null}}async _retrySpawn(e,t,n){try{await this._spawnClient(e,t,n)?console.log(`[LSP] Retry successful for ${e.id}`):this.retryStrategy.scheduleRetry(n,async()=>{this.emit("server-retrying",{serverId:e.id,root:t,attempt:this.retryStrategy.getRetryCount(n)}),await this._retrySpawn(e,t,n)})}catch(i){console.error(`[LSP] Retry failed for ${e.id}:`,i),this.retryStrategy.scheduleRetry(n,async()=>{this.emit("server-retrying",{serverId:e.id,root:t,attempt:this.retryStrategy.getRetryCount(n)}),await this._retrySpawn(e,t,n)})}}async touchFile(e,t=!1){let n=await this.getClientsForFile(e);for(let i of n)await i.openDocument(e);return t&&n.length>0&&await Promise.all(n.map(i=>i.waitForDiagnostics(e,3e3))),n.length}async fileChanged(e,t){let n=await this.getClientsForFile(e);for(let i of n)t?await i.changeDocument(e,t):await i.openDocument(e)}async fileSaved(e){let t=await this.getClientsForFile(e);for(let n of t)await n.saveDocument(e)}getAllDiagnostics(){let e={};for(let t of this.clients.values()){let n=t.getDiagnostics();for(let[i,r]of Object.entries(n))e[i]||(e[i]=[]),e[i].push(...r.map(a=>({...a,source:a.source||t.serverID})))}return e}getDiagnosticsForFile(e){let t=[];for(let n of this.clients.values()){let i=n.getDiagnostics();i[e]&&t.push(...i[e].map(r=>({...r,source:r.source||n.serverID})))}return t}async hover(e,t,n){let i=await this.getClientsForFile(e);for(let r of i)try{let a=await r.hover(e,t,n);if(a)return a}catch{}return null}async completion(e,t,n){let i=await this.getClientsForFile(e),r=[];for(let a of i)try{let o=await a.completion(e,t,n);if(o){let c=Array.isArray(o)?o:o.items||[];r.push(...c)}}catch{}return r}async definition(e,t,n){let i=await this.getClientsForFile(e);for(let r of i)try{let a=await r.definition(e,t,n);if(a)return a}catch{}return null}async references(e,t,n){let i=await this.getClientsForFile(e),r=[];for(let a of i)try{let o=await a.references(e,t,n);o&&r.push(...o)}catch{}return r}async getStatus(){let e=J(),t=[];for(let[n,i]of Object.entries(e)){let r=await i.checkInstalled(),a=Array.from(this.clients.values()).filter(o=>o.serverID===n).map(o=>({root:o.root,openDocuments:o.openDocuments.size,diagnosticCount:Array.from(o.diagnostics.values()).reduce((c,u)=>c+u.length,0)}));t.push({id:n,name:i.name,extensions:Array.isArray(i.extensions)?[...i.extensions]:[],enabled:this.isServerEnabled(n),installed:r,installable:i.installable,running:a.length>0,instances:a})}return t}async shutdown(){console.log("[LSP] Shutting down all servers..."),this.retryStrategy.cancelAll();let e=[];for(let t of this.clients.values())e.push(t.shutdown());await Promise.all(e),this.clients.clear(),this.broken.clear(),this.spawning.clear(),console.log("[LSP] All servers shut down")}};function ve(s){let t=["","Error","Warning","Info","Hint"][s.severity||0]||"Unknown",n=s.range,i=`${n.start.line+1}:${n.start.character+1}`,r=s.source||"unknown";return`[${t}] ${i} (${r}): ${s.message}`}function Ue(s={}){return new $(s)}export{R as CACHE_VERSION,ie as DiagnosticSeverity,E as LANGUAGE_EXTENSIONS,N as LSPClient,$ as LSPManager,L as SERVERS,Z as clearCache,Ue as createLSPManager,M as ensureCacheDir,W as findProjectRoot,ve as formatDiagnostic,J as getAllServers,P as getBinDir,Q as getBundledBunPath,x as getCacheDir,oe as getCacheInfo,A as getCachedBinaryPath,re as getExtensionForLanguage,B as getLanguageId,z as getNodeModulesDir,m as getNpmBinaryPath,ee as getNpmPath,de as getServer,V as getServersForExtension,H as initInstaller,G as installFromGitHub,U as installGoPackage,b as installNpmPackage,C as isCached,g as which};
