================================================================================
OAUTH PACKAGE SECURITY VULNERABILITY SUMMARY
Package: @anthropic-ai/anthropic-oauth v1.0.0
Date: December 3, 2025
Status: CRITICAL - DO NOT USE IN PRODUCTION
================================================================================

CRITICAL VULNERABILITIES (3)
================================================================================

1. PKCE VERIFIER USED AS STATE PARAMETER
   Location: src/oauth-client.ts:79
   Line 79: url.searchParams.set('state', pkce.verifier)

   Issue: OAuth 2.0 spec requires independent, random state parameter.
          Using PKCE verifier defeats CSRF protection.

   Impact: CSRF attacks, authorization code interception, account takeover
   CWE: CWE-352, CWE-640

   Fix: Generate random state with crypto.randomBytes(32), store independently


2. MISSING STATE PARAMETER VALIDATION
   Location: src/oauth-client.ts:115-136 (completeLogin method)
   Lines 120-123: Extracts state but never validates it

   Issue: State returned from OAuth server is never verified.
          No protection against state tampering or substitution.

   Impact: CSRF attacks completely bypassed, arbitrary state accepted
   CWE: CWE-352

   Fix: Store expected state during startLogin, validate returned state
        matches, prevent replay attacks by consuming state after use


3. SENSITIVE ERROR INFORMATION LEAKAGE
   Location: src/oauth-client.ts:140-143, 174-177, 242-245
   Lines 142, 176, 244: Error messages include response body

   Issue: OAuth server error responses exposed to caller and logs
          Response body may contain implementation details, error codes,
          rate limit information, account status, etc.

   Impact: Information disclosure enabling targeted attacks
   CWE: CWE-209

   Fix: Log full errors only in development mode, return generic errors
        Map specific status codes to safe error messages only


HIGH PRIORITY VULNERABILITIES (2)
================================================================================

4. MISSING RESPONSE VALIDATION
   Location: src/oauth-client.ts:145-149, 179-180, 247-251

   Issue: No validation of response content-type or JSON structure
          Type assertions with 'as' provide zero runtime checking
          Missing required fields not detected
          Wrong field types silently accepted

   Impact: Server response spoofing, invalid tokens accepted, crashes
   CWE: CWE-347, CWE-346

   Fix: Validate Content-Type header, parse JSON safely with try-catch,
        validate all required fields exist and have correct types


5. MISSING HTTPS ENFORCEMENT FOR CALLBACKS
   Location: examples/cli-example.ts:38-40, examples/api-key-example.ts:33-34

   Issue: Examples accept callback URLs without HTTPS validation
          Authorization codes could be transmitted over HTTP
          No redirect URI validation

   Impact: Authorization code leakage, MITM attacks on local networks
   CWE: CWE-295, CWE-296

   Fix: Validate callback URL uses HTTPS (except localhost for dev)
        Validate authorization code format before processing


MEDIUM PRIORITY VULNERABILITIES (2)
================================================================================

6. HARDCODED CLIENT ID
   Location: src/oauth-client.ts:12

   Issue: Client ID visible in source code, repositories, built artifacts
          All instances share same client ID, no per-installation tracking

   Impact: Reduced operational security, easier to target legitimate flows
   CWE: CWE-798

   Fix: Make configurable via environment variable with default fallback


7. NO EXPLICIT HTTPS VALIDATION
   Location: src/oauth-client.ts:13-17 (hardcoded URLs are HTTPS)

   Issue: While endpoints are hardcoded as HTTPS, no runtime validation
          No certificate pinning
          No protection against downgrade attacks

   Impact: Potential for HTTPS stripping attacks (low risk due to hardcoding)
   CWE: CWE-295

   Fix: Add explicit URL scheme validation, consider certificate pinning


LOW PRIORITY VULNERABILITIES (2)
================================================================================

8. TOKEN EXPIRATION RACE CONDITION
   Location: src/oauth-client.ts:267-270

   Issue: TOCTOU race between isTokenExpired() check and API call
          Token could expire between check and use

   Impact: API calls fail with 401, no automatic retry
   CWE: CWE-367

   Fix: Handle 401 responses with automatic token refresh and retry


9. API KEY EXPOSURE IN EXAMPLES
   Location: examples/api-key-example.ts:48, 52

   Issue: Examples print API keys to console
          Keys visible in terminal history and scrollback

   Impact: Users following example expose credentials in shell history
   CWE: CWE-532

   Fix: Examples should show how to save keys to files with proper permissions


================================================================================
OWASP TOP 10 MAPPING
================================================================================

A01:2021 - Broken Access Control         VULNERABLE  (State validation missing)
A02:2021 - Cryptographic Failures        COMPLIANT   (Uses HTTPS, PKCE)
A03:2021 - Injection                     COMPLIANT   (Safe URL handling)
A04:2021 - Insecure Design               VULNERABLE  (State misuse)
A05:2021 - Security Misconfiguration     VULNERABLE  (No HTTPS validation)
A06:2021 - Vulnerable Components         CHECK       (Audit @openauthjs/openauth)
A07:2021 - Identification & Auth         VULNERABLE  (State, code interception)
A08:2021 - Software/Data Integrity       VULNERABLE  (No response validation)
A09:2021 - Logging & Monitoring          VULNERABLE  (Error leakage)
A10:2021 - SSRF                          COMPLIANT   (Hardcoded endpoints)


================================================================================
IMMEDIATE ACTIONS REQUIRED
================================================================================

1. DO NOT DEPLOY TO PRODUCTION until fixes are implemented
2. If already deployed, invalidate all issued tokens
3. Implement Fix 1, 2, 3 immediately (within hours)
4. Implement Fix 4, 5 within 24 hours
5. Implement Fix 6 within 1 week
6. Run security tests for state validation (CSRF protection)
7. Notify users to re-authenticate after deployment


================================================================================
FILES MODIFIED FOR FIXES
================================================================================

Core Implementation (Required):
  src/oauth-client.ts        - All critical and high fixes
  examples/cli-example.ts    - HTTPS validation for callbacks
  examples/api-key-example.ts - HTTPS validation for callbacks

Configuration (Recommended):
  package.json               - No changes needed

Testing (Required):
  tests/oauth-client.test.ts - Add state validation tests
  tests/security.test.ts     - Add CSRF and injection tests


================================================================================
VERIFICATION CHECKLIST
================================================================================

Before deploying the fix:

Functionality:
  [ ] OAuth flow works end-to-end with new state validation
  [ ] Token exchange succeeds with correct code and state
  [ ] State mismatch is detected and rejected
  [ ] Token refresh works after exchange
  [ ] API key creation works correctly

Security:
  [ ] Tampered state values are rejected
  [ ] Missing state parameter is detected
  [ ] Authorization codes with wrong state are rejected
  [ ] Error messages don't contain sensitive data
  [ ] Response validation catches invalid fields
  [ ] HTTPS is enforced for callbacks (dev allows localhost)
  [ ] Authorization code format is validated

Testing:
  [ ] All unit tests pass
  [ ] All integration tests pass
  [ ] CSRF attack scenarios are tested
  [ ] State tampering is tested
  [ ] Missing field responses are tested
  [ ] MitM scenarios are documented

Deployment:
  [ ] Security review completed
  [ ] All fixes verified
  [ ] Release notes updated
  [ ] Existing tokens invalidated (if needed)
  [ ] Users notified


================================================================================
REFERENCES
================================================================================

RFC 6234: HTTPS Requirements
  https://tools.ietf.org/html/rfc6234

RFC 7636: PKCE (Proof Key for Code Exchange)
  https://tools.ietf.org/html/rfc7636

RFC 6749: OAuth 2.0 Authorization Framework
  https://tools.ietf.org/html/rfc6749

CWE-352: Cross-Site Request Forgery (CSRF)
  https://cwe.mitre.org/data/definitions/352.html

CWE-209: Information Exposure Through Error Messages
  https://cwe.mitre.org/data/definitions/209.html

OWASP OAuth 2.0 Cheat Sheet
  https://cheatsheetseries.owasp.org/cheatsheets/OAuth_2_Cheat_Sheet.html

Auth0 OAuth Security Best Practices
  https://auth0.com/blog/oauth-2-best-practices-for-secure-implementation/


================================================================================
CONTACT
================================================================================

For questions or clarifications about this audit, refer to:
  - SECURITY_AUDIT_REPORT.md (detailed findings)
  - REMEDIATION_GUIDE.md (code examples and fixes)

Audit conducted: December 3, 2025
Severity: CRITICAL
Action Required: Immediate

================================================================================
